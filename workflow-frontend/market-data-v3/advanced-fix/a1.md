Your AUTH WebSocket layer is correct and stable.
Your MARKET WebSocket lifecycle is not.

I will walk through this in a structured, systems-level way and then give you an exact corrective pattern.

1. What is working correctly (do not touch)
Auth WebSocket & leader election — ✅ CORRECT

These lines are all healthy:

[AUTH WS] I am a follower. Waiting for updates via BroadcastChannel.
[LeaderElection] No leader found. I am taking leadership.
[AUTH WS] I am LEADER. Connecting to ws://localhost:28020/ws/auth/status
[AUTH WS] Connected


This tells us:

BroadcastChannel leader election is functioning

Exactly one tab becomes leader

Auth WS connects once

Followers correctly do not connect

Token timeline, auth status, health endpoints are stable

You do not have a token/auth issue anymore.

2. What is broken (root cause)
Market WebSocket is thrashing due to React StrictMode + hook design

The critical sequence:

[WS] Connecting to ws://localhost:28020/ws/market
WebSocket connection failed: closed before established
disconnect @ marketWebSocket.ts:66
commitDoubleInvokeEffectsInDEV


This line is the smoking gun:

commitDoubleInvokeEffectsInDEV


That means:

React 18 StrictMode is mounting → unmounting → remounting your market WS effect intentionally.

Your code is not idempotent.

3. What exactly is happening

Timeline:

useMarketData() mounts

marketWebSocket.connect() is called

React StrictMode immediately unmounts

disconnect() fires before handshake completes

Browser logs:

WebSocket is closed before the connection is established


Component mounts again

You connect again

Meanwhile:

POST /api/market/subscribe
POST /api/market/unsubscribe


are racing each other

This creates subscribe / unsubscribe storms.

4. Why AUTH WS does not fail but MARKET WS does

Because:

Auth WS has leader election + singleton guard

Market WS does not

Auth WS:

Leader → connect
Follower → do nothing


Market WS:

Every mount → connect
Every unmount → disconnect


That is the architectural difference.

5. The professional fix (mandatory)
Rule for Market Data WS

Market WebSocket must be process-singleton, not component-bound.

6. Correct Market WS architecture (Vega-grade)
6.1 Create a singleton connection guard
// marketWebSocket.ts
let ws: WebSocket | null = null;
let connected = false;

export function connectMarketWS() {
  if (ws && connected) {
    console.log("[WS] Already connected, skipping");
    return;
  }

  ws = new WebSocket("ws://localhost:28020/ws/market");

  ws.onopen = () => {
    connected = true;
    console.log("[WS] Connected");
  };

  ws.onclose = () => {
    connected = false;
    ws = null;
    console.log("[WS] Disconnected");
  };

  ws.onerror = (e) => {
    console.error("[WS] Error", e);
  };
}

export function disconnectMarketWS() {
  // DO NOT disconnect on React unmount in dev
  if (import.meta.env.DEV) return;

  ws?.close();
}

6.2 Fix useMarketData (critical)
❌ Current (implied)
useEffect(() => {
  connectMarketWS();
  return () => disconnectMarketWS();
}, []);


This is wrong in React 18.

✅ Correct (production-safe)
useEffect(() => {
  connectMarketWS();

  return () => {
    // no-op in dev
  };
}, []);


If you truly need cleanup:

Do it on logout

Do it on tab close

Do it on leader loss

Not on component unmount.

7. Subscription API storm fix

You currently have:

POST /api/market/subscribe
POST /api/market/unsubscribe
POST /api/market/subscribe


You need a subscription reference counter.

Example:
let subscriptionCount = 0;

export function subscribe(symbols: string[]) {
  subscriptionCount++;
  if (subscriptionCount > 1) return;

  http.post("/api/market/subscribe", { symbols });
}

export function unsubscribe(symbols: string[]) {
  subscriptionCount--;
  if (subscriptionCount > 0) return;

  http.post("/api/market/unsubscribe", { symbols });
}


This prevents thrashing.

8. Why this only shows up now

Because earlier:

Your app crashed before market WS mounted

Auth bugs masked market lifecycle bugs

Now that auth is stable, market infra issues are visible.

This is normal progression.

9. Validation checklist (after fix)

You should see exactly once:

[WS] Connecting to ws://localhost:28020/ws/market
[WS] Connected


And never see:

WebSocket is closed before the connection is established


In dev or prod.