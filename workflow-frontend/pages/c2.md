Below is the institutional-grade continuation of the VEGA TRADER Terminal architecture. This section completes the Tier-1 OMS/EMS control stack and is written so it can be attached directly to audit, risk committee, or exchange certification documentation.

5. Command Sandbox (Dry-Run Mode)
5.1 Purpose

The Command Sandbox allows traders, QA, and operators to:

Validate command syntax

Verify risk, margin, and permission outcomes

Observe expected state transitions
without executing any irreversible action

This is a mandatory control in modern trading terminals (Bloomberg has SIM, TEST, EMSX preview modes).

5.2 Sandbox Definition

Sandbox mode simulates:

Order validation

Risk checks

Margin checks

Token validation

Kill-switch enforcement

Sandbox mode never:

Sends orders to broker

Writes to OMS tables

Emits WebSocket market subscriptions

5.3 Activation Model
Keyboard
SANDBOX ON <ENTER>
SANDBOX OFF <ENTER>

UI Indicator
████████████████████
 SANDBOX MODE ACTIVE
████████████████████


Yellow banner (Bloomberg-style).

5.4 Backend Enforcement (Hard Boundary)
if (executionContext.isSandbox()) {
    return sandboxExecutor.simulate(command);
}


Sandbox executor shares:

Validation logic

Risk engine

Margin engine

But uses:

Stub broker gateway

In-memory order book

5.5 Sandbox Result Schema
{
  "command": "BUY RELIANCE 100",
  "status": "SIMULATED_OK",
  "checks": {
    "token": "VALID",
    "risk": "PASS",
    "marginRequired": 125000,
    "killSwitch": "INACTIVE"
  },
  "execution": "BLOCKED_BY_SANDBOX"
}

5.6 Audit Controls

Sandbox executions are logged with SIMULATED=true

Sandbox logs are non-reportable to exchanges

6. Latency Heatmaps per Command
6.1 Objective

Measure and visualize:

Input → validation latency

Validation → broker latency

Broker → acknowledgement latency

This allows performance SLAs, root-cause analysis, and trader experience tuning.

6.2 Latency Capture Points
Stage	Metric
Command Parse	cmd_parse_ms
Risk Validation	risk_ms
DB Writes	db_ms
Broker Call	broker_ms
Total	end_to_end_ms
6.3 Backend Metric Model
record CommandLatency(
    String command,
    long parseMs,
    long riskMs,
    long dbMs,
    long brokerMs,
    long totalMs
) {}


Metrics exported via:

Micrometer

Prometheus

Actuator

6.4 Heatmap UI (Bloomberg-Style)
CMD     AVG(ms)   P95(ms)
BUY     ██████     ████████
SELL    ████       █████
POS     ██         ██


Color scale:

Green < 50ms

Amber 50–150ms

Red > 150ms

6.5 Operational Use

Identify broker throttling

Detect DB contention (SQLite locks)

Validate infra upgrades

7. Trader Behavior Anomaly Detection
7.1 Objective

Detect non-normal trader behavior early:

Fat-finger risk

Automation misuse

Insider-style bursts

Compromised accounts

7.2 Behavior Signals
Signal	Example
Command Velocity	50 orders in 10s
Time-of-Day Deviation	Trading at 03:00
Instrument Concentration	90% in one symbol
Latency Pattern	Script-like precision
7.3 Feature Vector
{
  "ordersPerMinute": 42,
  "uniqueSymbols": 1,
  "avgLatency": 8,
  "commandEntropy": 0.2,
  "timeWindow": "09:15-09:17"
}

7.4 Detection Logic (Phase-1 Rule Based)
if (ordersPerMinute > threshold && uniqueSymbols == 1) {
    flagAnomaly(TRADER_BURST);
}

7.5 Detection Logic (Phase-2 ML Ready)

Isolation Forest

EWMA baselines

Per-trader historical profile

7.6 Response Actions
Severity	Action
Low	Flag only
Medium	Switch to RESTRICTED
High	Auto-kill trader session
7.7 Audit Trail
{
  "event": "TRADER_ANOMALY",
  "user": "trader01",
  "signal": "ORDER_BURST",
  "action": "RESTRICTED_MODE"
}

8. Replay-Based Incident Reconstruction
8.1 Objective

Enable forensic reconstruction of any incident:

Market outage

Wrong trade

Kill-switch activation

Regulatory inquiry

Equivalent to Bloomberg audit replay.

8.2 Event Sourcing Model

Every event is immutable:

Event Type
Command Entered
Validation Result
Order Sent
Broker Response
UI State Change
Kill-Switch
8.3 Unified Event Schema
{
  "eventId": "uuid",
  "timestamp": "2025-01-01T10:21:07Z",
  "user": "trader01",
  "eventType": "COMMAND_EXECUTED",
  "payload": {
    "command": "BUY RELIANCE 100",
    "latency": 82
  }
}


Stored in:

Append-only table

Or Kafka-compatible log

8.4 Replay Engine
public void replay(Instant from, Instant to) {
    events.stream()
          .filter(e -> e.inRange(from, to))
          .forEach(this::apply);
}

8.5 Replay UI

Controls:

Timeline scrubber

Speed (1x, 10x)

Filter by trader / symbol

State snapshots

10:21:01 POS
10:21:04 BUY RELIANCE
10:21:07 KILL

8.6 Regulatory Readiness

This satisfies:

SEBI post-trade audit

Exchange incident reporting

Internal compliance investigations

Final System Maturity Assessment

With these additions, VEGA TRADER now meets:

Capability	Status
OMS Safety	COMPLETE
Risk Governance	COMPLETE
Auditability	COMPLETE
Operator Control	COMPLETE
Terminal UX	BLOOMBERG-GRADE