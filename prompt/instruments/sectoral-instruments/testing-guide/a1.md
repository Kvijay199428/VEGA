Below is a strict, documentation-first Testing Guide that you should complete before writing any Instruments documentation.
This is written as an internal QA / engineering SOP, not marketing docs.

Instruments Module – Testing Guide (Pre-Documentation)
0. Purpose of This Guide

This testing phase ensures that:

Instrument data is correct, deterministic, and immutable

RMS and eligibility logic behave identically across environments

Sectoral / index-based instruments do not corrupt core instrument master

Documentation will describe verified behavior, not assumptions

Rule:
❌ No documentation should be written until all tests below are green.

1. Test Environments
1.1 Mandatory Environments
Environment	Purpose
Local (H2/SQLite)	Developer correctness
Staging DB snapshot	Data accuracy
Cold start DB	Bootstrap & migrations
Read-only DB	Immutability checks
1.2 Required Test Modes

Fresh DB (no data)

Incremental update (existing instruments)

Partial failure (CSV fetch fails)

Concurrent reads during ingestion

2. Instrument Master Testing
2.1 Schema Validation Tests

Objective: Ensure instrument data schema is stable.

Tests

Column presence validation

Non-null constraints

Enum correctness (EQ/FUT/OPT)

Exchange series correctness (NSE/BSE)

FAIL IF:
- Symbol without ISIN
- Duplicate instrument_key
- Unknown exchange

2.2 Instrument Key Determinism Test

Objective: Verify instrument keys are never constructed ad-hoc.

Test Case
Input	Expected
Symbol = INFY	instrument_key resolved from DB
Symbol missing	Lookup fails cleanly
Same symbol twice	Same key always

❌ FAIL if instrument_key is derived dynamically
✅ PASS only if DB is authoritative

2.3 Instrument Immutability Test

Objective: Ensure master data is read-only.

Tests

UPDATE query rejected

DELETE query rejected

Only SYSTEM role can INSERT

Attempt:
UPDATE instrument_master SET isin = 'X'

Expected:
Exception: IMMUTABLE_ENTITY

3. CSV Ingestion & Sectoral Index Testing
3.1 CSV Fetch Tests

Objective: Ensure external CSV ingestion is safe.

Tests

HTTP 200 validation

Header match validation

Encoding handling

Retry + timeout behavior

FAIL IF:
- Header mismatch
- Empty CSV ingested
- Partial rows persisted

3.2 Symbol Resolution Test (Critical)

Objective: Ensure CSV symbols map to existing instruments.

Test Matrix
CSV Symbol	Instrument Master	Result
Present	Present	Mapped
Missing	Missing	Logged + skipped
Duplicate	Present	Deduplicated

❌ Never create instruments from CSV

3.3 Sector Mapping Integrity

Objective: Ensure sectoral data is layered, not merged.

Tests

sector_instrument_map table populated

instrument_master untouched

Multiple sectors per instrument allowed

4. Eligibility & RMS Testing
4.1 Eligibility Cache Consistency

Objective: Ensure eligibility uses same instrument view everywhere.

Tests

Cache warm-up

Cache eviction

Cache reload after CSV update

Instrument eligibility should not change
unless RMS rules change

4.2 RMS Validation Scenarios

Test before order placement.

Scenario	Expected
PCA flagged instrument	Reject
ASM instrument	Margin applied
IPO lock-in	Reject
Quantity cap exceeded	Reject
5. Search & Discovery Testing
5.1 Search Modes

Test all modes with same dataset.

Mode	Expected
Symbol search	Exact
Sector search	Filtered
Fuzzy search	Ranked
Index search	Constituents only
5.2 Cross-Interface Parity

Ensure identical results across:

REST /instruments/search

CLI instrument search

Vite frontend search

❌ UI-only filters are not allowed

6. Broker Mapping Tests
6.1 Broker Symbol Mapping

Objective: Ensure broker adapters never bypass master.

Tests

Instrument → broker_symbol resolution

Missing mapping behavior

Multi-broker consistency

6.2 Order Placement Pre-Checks

Ensure instrument passes:

Eligibility

Client risk

Broker support

Before adapter invocation.

7. Settings Impact Testing
7.1 Settings Boundary

Ensure settings only affect filters and display.

Setting	Must NOT Affect
Sector filter	RMS
Search mode	Instrument key
UI toggles	Eligibility
7.2 Role Enforcement

Attempt illegal setting change.

Role	Action	Expected
Trader	Modify RMS	Reject
Viewer	Enable trading	Reject
Admin	Modify master	Reject
8. Failure & Recovery Tests
8.1 Partial Ingestion Failure

CSV fetch fails

DB transaction rolls back

Old data remains active

8.2 Restart Recovery

Restart during ingestion

Restart during cache rebuild

Restart during order search

System must recover without corruption.

9. Audit & Logging Verification
9.1 Mandatory Logs

Ensure logs exist for:

CSV ingestion

Symbol mismatch

RMS rejection

Settings update

9.2 Audit Integrity

Audit records must contain:

User / SYSTEM

Timestamp

Old value → new value

Source (CSV, API, UI)

10. Final Gate Before Documentation

Documentation must not begin unless:

All tests are automated or reproducible

No manual DB patching required

Instrument key is proven DB-derived

RMS behavior is invariant