Proceeding with the next mandatory artifact:
a diagram-ready guide that you can directly use to generate sequence diagrams, data-flow diagrams, and architecture diagrams for the Instruments + Sectoral Indexing system.

This answers exactly what to put in documentation and diagram tools (PlantUML / Mermaid / Draw.io).

Instruments Module – Diagram Generation Guide (Authoritative)

This section is diagram-first, not prose.

1. System Boundary Diagram (High-Level)
Purpose

Explain where instrument data originates, how it is enriched, and how it is consumed.

Components to show
External Sources
 ├── NSE Instrument Master
 ├── NSE Index CSVs (Sectoral / Thematic)
 ├── Regulatory Lists (PCA / ASM / GSM)

Backend
 ├── Instrument Loader
 ├── Index Constituent Loader
 ├── Instrument Database (SQLite / Prod DB)
 ├── InstrumentService
 ├── RMS Validation Service
 ├── Broker Engine

Consumers
 ├── REST API
 ├── Frontend (Vite + React)
 ├── Trading Engine

Key annotation

Instrument identity is immutable and database-backed.

2. Instrument Ingestion Flow (Sequence Diagram)
Title

Daily Instrument & Sector Sync Flow

Actors

Scheduler / CLI

InstrumentLoader

IndexConstituentLoader

Database

Sequence (exact)
Scheduler
  → InstrumentLoader : loadInstrumentMaster()
  → Database : upsert instrument_master

Scheduler
  → IndexConstituentLoader : loadIndex(indexConfig)
  → NSE CSV Endpoint : download CSV
  → IndexConstituentLoader : parse rows
  → Database : validate instrument_key exists
  → Database : upsert index_constituent
  → Database : update index_master.last_updated

Notes to annotate

Missing instruments are skipped

Loader is idempotent

Sector mapping never creates instruments

3. Instrument Search Flow (Core Diagram)
Title

Instrument Search with Sector Overlay

Actors

Frontend

REST API

InstrumentService

Database

Sequence
Frontend
 → REST /api/instruments/search?q=bank&sector=BANKING

REST API
 → InstrumentService.search()

InstrumentService
 → Database : query instrument_master
 → Database : join instrument_sector_view
 → Database : apply filters
 → InstrumentService : ranked results

REST API
 → Frontend : instrument list

Highlight

Sector filter is optional

Symbol-only search still works

Ranking prioritizes sector relevance

4. Order Placement + RMS Validation Flow (Critical)
Title

Order Validation with Instrument & Sector Awareness

Actors

Frontend

REST API

Eligibility Cache

RMS Validation Service

Client Risk Evaluator

Multi-Broker Engine

Broker Adapter (Upstox)

Sequence (exact)
Frontend
 → REST /orders/place

REST API
 → EligibilityCache : resolve product eligibility
 → RMSValidationService : validate instrument

RMSValidationService
 → InstrumentService : fetch instrument metadata
 → SectorResolver : resolve sector/index
 → ClientRiskEvaluator : check limits

[If rejected]
 → REST API : return rejection reason

[If approved]
 → MultiBrokerEngine : route order
 → UpstoxAdapter : placeOrder()
 → Broker API : order accepted

Rejection paths to mark

Instrument inactive

Sector blocked

Quantity cap exceeded

Client risk breached

5. Instrument Key Resolution Diagram (Clarification Diagram)
Title

How Instrument Keys Are Derived

Flow
CSV Symbol
  → Prefix by exchange (NSE_EQ)
  → instrument_key = NSE_EQ|SYMBOL
  → validate existence in instrument_master
  → store reference only

Important annotation

❗ Instrument key is never constructed at runtime for trading
❗ It must already exist in instrument_master

6. Sector Indexing Data Model Diagram
Tables to show
instrument_master
  └── instrument_key (PK)

sector_master
  └── sector_code (PK)

index_master
  └── index_code (PK)
  └── sector_code (FK)

index_constituent
  └── (index_code, instrument_key) (PK)

View
instrument_sector_view


Explain:

Many-to-many mapping

One instrument → many indices

One sector → many indices

7. Frontend Autocomplete Flow
Title

Sector-Aware Autocomplete

Sequence
User types "bank"
 → Debounce (300ms)
 → REST /search?q=bank

Backend
 → Rank:
    1. Symbol match
    2. Sector membership
    3. Index membership
 → Return list

Frontend
 → Highlight sector badges

8. Error Handling Diagram
Title

Failure & Degradation Paths

Include:

CSV download failure → last-known-good retained

Missing instrument → row skipped

RMS failure → hard reject

Broker failure → retry / error propagate

9. What NOT to Include (Important)

Do NOT show:

Broker-specific instrument formats

Dynamic instrument creation

Sector affecting broker routing

This keeps architecture clean.

10. Diagram Checklist (Before Publishing Docs)

Ensure diagrams show:

Database as source of truth

Immutable instrument identity

Sector as overlay classification

RMS enforcement boundaries

Broker isolation

11. Tools Recommendation
Purpose	Tool
Sequence diagrams	PlantUML
Data model	Draw.io
Architecture	Mermaid
Docs	Markdown + Diagrams
Final Statement for Documentation

“Instrument identity is immutable and stored in the database.
Sector and index classification are derived overlays used for discovery, eligibility, and risk control, without altering trading semantics.”