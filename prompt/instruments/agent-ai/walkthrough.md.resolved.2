# Instrument Module Upgrade - Walkthrough

## Summary

Successfully implemented a comprehensive upgrade to the VEGA TRADER instrument module based on the specifications in `prompt/instruments/dev/*.md`.

---

## Files Created

### Phase 1: Database Schema (Flyway Migrations)

| File | Description |
|------|-------------|
| [V10__instrument_master.sql](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/resources/db/migration/V10__instrument_master.sql) | Core instrument_master table with indexes |
| [V11__instrument_overlays.sql](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/resources/db/migration/V11__instrument_overlays.sql) | MIS, MTF, Suspension overlay tables |
| [V12__product_risk_profile.sql](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/resources/db/migration/V12__product_risk_profile.sql) | Product risk profiles + sectoral constituents |

---

### Phase 2: Entity & Repository Layer

**Entities:**
| File | Description |
|------|-------------|
| [InstrumentMasterEntity.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/entity/InstrumentMasterEntity.java) | Core instrument JPA entity |
| [InstrumentMisEntity.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/entity/InstrumentMisEntity.java) | MIS overlay entity |
| [InstrumentMtfEntity.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/entity/InstrumentMtfEntity.java) | MTF overlay entity |
| [InstrumentSuspensionEntity.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/entity/InstrumentSuspensionEntity.java) | Suspension overlay entity |
| [ProductRiskProfileEntity.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/entity/ProductRiskProfileEntity.java) | Risk profile entity |

**Repositories:**
| File | Description |
|------|-------------|
| [InstrumentMasterRepository.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/repository/InstrumentMasterRepository.java) | Search, autocomplete, options chain queries |
| [InstrumentMisRepository.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/repository/InstrumentMisRepository.java) | MIS overlay repository |
| [InstrumentMtfRepository.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/repository/InstrumentMtfRepository.java) | MTF overlay repository |
| [InstrumentSuspensionRepository.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/repository/InstrumentSuspensionRepository.java) | Suspension check repository |
| [ProductRiskProfileRepository.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/repository/ProductRiskProfileRepository.java) | Risk profile lookup |

---

### Phase 3: Loader Service

| File | Description |
|------|-------------|
| [InstrumentFileSource.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/loader/InstrumentFileSource.java) | Enum with all Upstox JSON URLs |
| [InstrumentLoaderService.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/loader/InstrumentLoaderService.java) | Streaming JSON loader with batch inserts |
| [DailyRefreshScheduler.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/loader/DailyRefreshScheduler.java) | 6 AM IST cron job for daily refresh |

---

### Phase 4: Validation Patterns

| File | Description |
|------|-------------|
| [InstrumentKeyPattern.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/validation/InstrumentKeyPattern.java) | Java-safe regex patterns for key validation |
| [ValidInstrumentKey.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/validation/ValidInstrumentKey.java) | Bean Validation annotation |
| [ValidExchange.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/validation/ValidExchange.java) | Exchange validation annotation |

---

### Phase 5: Search & API

| File | Description |
|------|-------------|
| [InstrumentSearchService.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/search/InstrumentSearchService.java) | Autocomplete, resolve, options chain |
| [InstrumentController.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/controller/InstrumentController.java) | REST endpoints |

---

### Phase 6: Risk Engine

| File | Description |
|------|-------------|
| [ProductType.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/risk/ProductType.java) | CNC/MIS/MTF enum with margin calculation |
| [RiskValidationService.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/risk/RiskValidationService.java) | Order validation with risk checks |

---

## New REST Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/instruments/resolve` | Symbol → instrument_key resolution |
| GET | `/api/v1/instruments/autocomplete` | Autocomplete search |
| GET | `/api/v1/instruments/search` | Full search with filters |
| GET | `/api/v1/instruments/{key}` | Get instrument by key with overlays |
| GET | `/api/v1/instruments/expiries` | Get expiry dates for underlying |
| GET | `/api/v1/instruments/options-chain` | Get options chain |
| POST | `/api/v1/instruments/load` | Manual instrument load trigger |
| POST | `/api/v1/instruments/refresh` | Full daily refresh trigger |

---

## Modified Files

| File | Change |
|------|--------|
| [SectoralIndex.java](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/sectoral/SectoralIndex.java) | Added `FINANCIAL_SERVICES_EX_BANK` sector |

---

## Verification

✅ **Maven Compile**: Exit code 0 - All classes compile successfully

---

## Next Steps (Optional)

1. Add Flyway dependency to [pom.xml](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/pom.xml) for automatic migrations
2. Create [DailyRefreshScheduler](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/loader/DailyRefreshScheduler.java#26-124) for 6 AM cron job
3. Add Redis caching for autocomplete
4. Create integration tests
5. Update existing [InstrumentEnrollmentService](file:///d:/projects/VEGA%20TRADER/backend/java/vega-trader/src/main/java/com/vegatrader/upstox/api/instrument/service/InstrumentEnrollmentService.java#29-347) to use new repositories

---

## v4.1 RMS Control Plane Upgrade

Added institutional-grade Risk Management System based on b1-b3.md specs.

### New Database Tables (10)

| Table | Purpose |
|-------|---------|
| `equity_security_type` | NORMAL, SME, IPO, PCA, RELIST |
| `exchange_series` | NSE/BSE series with settlement flags |
| `exchange_series_source` | Dynamic series sync tracking |
| `regulatory_watchlist` | PCA/Surveillance tracking |
| `ipo_calendar` | Listing day restrictions |
| `intraday_margin_by_series` | Series-based margin % |
| `symbol_quantity_caps` | Per-symbol qty/value limits |
| `price_band` | Daily price limits |
| `fo_contract_lifecycle` | F&O expiry tracking |

### New Components

```
rms/
├── eligibility/
│   ├── ProductEligibility.java
│   ├── EligibilityResolver.java
│   └── EligibilityCache.java
├── entity/ (8 entities)
├── repository/ (7 repositories)
└── validation/
    ├── MarginProfile.java
    ├── RmsException.java
    ├── RmsValidationResult.java
    └── RmsValidationService.java
```

### Eligibility Cache
- Caffeine LoadingCache: 100K entries, 60s TTL
- Zero DB hits on order placement
- Full decision flow: PCA → T2T → IPO → Security Type

---

*Completed: 2025-12-30*
