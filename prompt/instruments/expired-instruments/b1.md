Here’s a detailed enterprise-ready integration plan that ties the user settings directly with the expired instruments and historical data fetch service, making the feature fully configurable and safe for multi-interface access (CLI, REST, frontend).

1. Architecture Overview
                +----------------------+
                |      Frontend        |
                |  (React/Vite UI)     |
                +----------+-----------+
                           |
                           v
                +----------------------+
                |     REST API Layer   |
                |  /expired-data       |
                |  /user-settings      |
                +----------+-----------+
                           |
           +---------------+-----------------+
           |                                 |
           v                                 v
+---------------------+           +---------------------+
|  Expired Instrument |           |  User Settings      |
|  Service            |           |  Service            |
|  - Fetch expiries   |           |  - Validate/update  |
|  - Fetch contracts  |           |  - Default settings |
|  - Fetch OHLC data  |           |  - Role-based access|
+---------------------+           +---------------------+
           |
           v
+---------------------+
|  Caching Layer      |
|  (Redis / Memory)   |
|  - Expiry lists     |
|  - Contracts        |
+---------------------+
           |
           v
+---------------------+
|  Database / Storage |
|  - Persist fetched  |
|    historical data  |
|  - Sector mappings  |
+---------------------+

2. Integration Flow

Frontend / CLI / REST call requests expired instrument historical data.

UserSettingsService retrieves the user’s settings:

Interval (1minute, 5minute, day, etc.)

Max historical days

Default sectors

Include weekly options

ExpiredInstrumentService:

Fetch expiry dates (with caching if enabled)

Fetch expired option/future contracts for those expiries

Fetch historical OHLC/volume/OI data according to user settings

Sectoral Filtering:

If user selected sectors, only fetch instruments belonging to those sectors

Return Data:

Apply user preferences (interval, limit days)

Return data to frontend, CLI, or REST consumer

Caching & Persistence:

Store fetched expiries and contracts for performance

Historical data can be optionally persisted for repeated queries

3. User Settings Controls in Expired Instruments Service
Setting	Usage in Service	Default Value
default_expiry_fetch	Fetch only latest or all expiries	latest
default_instrument_type	Options, Futures, Both	both
default_interval	Candle interval for historical data	day
auto_cache_expiries	Cache expiry lists to reduce API calls	true
auto_cache_contracts	Cache option/future contracts	true
max_historical_days	Limit historical OHLC fetch	365
show_weekly_options	Include weekly options	true
default_sector_filter	Filter instruments by sector	["Nifty IT","Nifty Bank"]
4. Pseudocode Integration
public class ExpiredInstrumentFetcher {

    private UserSettingsService userSettingsService;
    private ExpiredInstrumentApi api;
    private CacheService cache;

    public List<HistoricalCandle> fetchData(String userId, String instrumentKey) {

        UserSettings settings = userSettingsService.getSettings(userId);

        List<String> expiries = cache.getExpiries(instrumentKey);
        if (expiries == null || !settings.isAutoCacheExpiries()) {
            expiries = api.fetchExpiries(instrumentKey);
            if (settings.isAutoCacheExpiries()) cache.setExpiries(instrumentKey, expiries);
        }

        // Filter expiries if max_historical_days is set
        expiries = filterExpiriesByMaxDays(expiries, settings.getMaxHistoricalDays());

        // Fetch contracts
        List<Contract> contracts = new ArrayList<>();
        for (String expiry : expiries) {
            contracts.addAll(api.fetchContracts(instrumentKey, expiry, settings.getDefaultInstrumentType()));
        }

        // Sector filtering
        if (!settings.getDefaultSectorFilter().isEmpty()) {
            contracts = filterContractsBySector(contracts, settings.getDefaultSectorFilter());
        }

        // Fetch historical candles
        List<HistoricalCandle> candles = new ArrayList<>();
        for (Contract c : contracts) {
            candles.addAll(api.fetchHistoricalCandle(c.getExpiredInstrumentKey(), settings.getDefaultInterval()));
        }

        return candles;
    }
}

5. CLI & REST Examples
CLI
# Fetch expired NIFTY options for the user with default settings
$ myapp expired fetch --instrument NSE_INDEX|Nifty50

REST
GET /expired-data?instrument_key=NSE_INDEX|Nifty50&user_id=12345


Response respects:

Interval

Sector filter

Max historical days

6. Future-proof Features

Dynamic Sector Updates: Provide new CSV links → auto-map instruments to sectors.

Auto-cache: Expiries and contracts cached for all users.

User Role Control: Admin can override global defaults.

Multi-interface Access: Settings respected across CLI, REST, and frontend.

Audit Logging: Track all fetch and update actions.

7. Next Steps

Implement UserSettingsService and integrate with ExpiredInstrumentFetcher.

Build sector mapping ingestion using CSV links.

Implement caching and persistence layers.

Add CLI & REST endpoints to expose this feature.

Write integration + unit tests for:

Settings validation

Expiry fetch

Contract fetch

Historical data fetch

Sector filter

Document enterprise feature guide.