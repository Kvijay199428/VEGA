Below is a documentation-ready, enterprise-grade guide for fetching expired instruments and their historical data, designed to fit cleanly into your Instruments Module without ambiguity.
This explains what is stored, what is derived, what is fetched live, and how to upgrade your system safely.

Expired Instruments & Historical Data – Design and Usage Guide
1. Purpose of This Upgrade

The Expired Instruments framework enables your platform to:

Discover all historical expiries of an underlying (index / stock)

Resolve expired option & future contracts

Fetch historical OHLC + OI data for expired derivatives

Enable backtesting, analytics, and compliance workflows

This capability is read-only, analytical, and completely isolated from live trading risk.

2. Core Concept: What Is an Expired Instrument?
2.1 Normal Instrument Key (Live)
NSE_INDEX|Nifty 50
NSE_FO|47983


Represents a tradable or reference instrument.

2.2 Expired Instrument Key (Derived)
<normal_instrument_key>|<DD-MM-YYYY>


Example:

NSE_FO|47983|17-04-2025


Key characteristics:

Property	Value
Derived	Yes
Stored in DB	❌ No
Constructed	At runtime
Used for	Historical queries only

⚠️ Expired instruments are never stored in instrument_master

3. System Architecture Overview
Instrument Master (DB)
        ↓
Underlying Instrument Key
        ↓
Upstox Expiry API
        ↓
Expiry Dates
        ↓
Expired Contracts (Options / Futures)
        ↓
Expired Instrument Key (runtime)
        ↓
Historical Candle API

4. Step-by-Step Flow (Canonical)
STEP 1: Resolve Underlying Instrument

Source: Your Instrument Master DB

Example:

NSE_INDEX|Nifty 50


Must exist in DB

Must match regex from Field Pattern

Used as the root key

STEP 2: Fetch Available Expiry Dates

API

GET /v2/expired-instruments/expiries


Purpose

Discover all weekly + monthly expiries

Includes up to 6 months of historical expiries

MCX currently unsupported

System Rule

Expiries are not cached permanently

Can be cached short-term (TTL: 24h)

STEP 3: Fetch Expired Contracts (Option / Future)
Option Contracts
GET /v2/expired-instruments/option/contract

Future Contracts
GET /v2/expired-instruments/future/contract


Input

underlying instrument_key

expiry_date

Output

strike

CE / PE / FUT

exchange_token

lot_size

underlying_key

This step resolves exchange_token + expiry, which is required for historical candles.

STEP 4: Construct expired_instrument_key (Runtime)

From API response:

instrument_key + "|" + expiry_date


Example:

NSE_FO|73507|24-04-2025


Important Rules

Never stored in DB

Never reused for trading

Exists only for historical access

STEP 5: Fetch Historical Candle Data

API

GET /v2/expired-instruments/historical-candle


Supported Intervals

1minute | 3minute | 5minute | 15minute | 30minute | day


Data Returned

Timestamp

OHLC

Volume

Open Interest

Use Cases

Backtesting

Volatility modeling

Strategy research

Regulatory analysis

5. Data Ownership Model
Data Type	Source	Stored
Instrument master	Exchange CSV	✅ DB
Expiry dates	Upstox API	❌
Expired contracts	Upstox API	❌
Expired instrument key	Runtime	❌
Historical candles	Upstox API	Optional (warehouse)

If stored, historical data must go to a time-series or analytics store, not instrument DB.

6. Database Impact (Very Important)
❌ What You DO NOT Do

Do not insert expired instruments into instrument_master

Do not create expiry rows per contract

Do not mutate existing FO lifecycle tables

✅ What You MAY Add (Optional)

expired_data_fetch_audit

historical_data_cache_meta

analytics_snapshot

7. Instrument Service Responsibilities
InstrumentService

Validates underlying instrument_key

Verifies segment eligibility (NSE_FO / NSE_INDEX)

Provides canonical symbol resolution

ExpiredInstrumentService (New)

Fetches expiries

Fetches expired contracts

Constructs expired_instrument_key

Delegates candle fetch

MarketDataService

Fetches historical candles

Normalizes OHLC format

Optional persistence

8. Error Handling Strategy
Scenario	Handling
Invalid instrument_key	Reject
Expiry not found	Empty response
Expired key malformed	Reject
Date range invalid	Reject
API 4XX	Bubble up
API 5XX	Retry + circuit breaker
9. Security & Risk Isolation

Expired instrument APIs are read-only

No RMS checks required

No order placement possible

No broker mapping required

This guarantees zero trading risk from expired data usage.

10. Testing Strategy (Mandatory)
Unit Tests

expired_instrument_key construction

regex validation

interval validation

Integration Tests

expiry fetch

option / future contract resolution

candle fetch (mocked)

Negative Tests

MCX expiry request

invalid date range

invalid instrument_key

11. CLI / REST / Frontend Usage Consistency

All interfaces must follow same logical flow:

Underlying → Expiry → Contract → Expired Key → Candles


No UI-specific shortcuts allowed.

12. Documentation Checklist (Before Publishing)

✅ Regex documented

✅ Runtime-derived keys explained

✅ Storage policy clarified

✅ Risk isolation stated

✅ Testing guarantees listed

13. Key Takeaway (Critical)

Expired instruments are NOT instruments in your system.
They are derived analytical identifiers used exclusively for historical data access.

This separation is what keeps your instrument model clean, safe, and enterprise-grade.