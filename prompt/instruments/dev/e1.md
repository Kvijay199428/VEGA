Let’s extend the backend architecture to include settings management and logging infrastructure, especially for instrument-related features. This will give operational control and observability for the full trading stack.

MODULE 6 — SETTINGS & LOGGING INFRASTRUCTURE
1. Overview

We add:

Settings Management — dynamic configuration for instrument behavior, product eligibility, margins, and risk checks.

Logging / Observability — structured logging for all instrument, order, and risk events, with levels (INFO, WARN, ERROR, DEBUG).

These modules allow runtime control and detailed tracking without requiring code redeployment.

2. Settings Management
2.1 Configuration Table
CREATE TABLE settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    category TEXT NOT NULL,        -- e.g., INSTRUMENT, RISK, MTF, MIS
    key TEXT NOT NULL,             -- e.g., intraday_margin_enabled
    value TEXT NOT NULL,           -- JSON / string / numeric
    description TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


category groups settings logically (e.g., INSTRUMENT, RISK, LOGGING).

value can store JSON for complex configs (like margin % by series).

Example entries:

category	key	value	description
INSTRUMENT	mtf_enabled_default	true	Default MTF eligibility
INSTRUMENT	mis_enabled_default	true	Default MIS eligibility
RISK	intraday_var_threshold	100000	Max intraday VaR per client
LOGGING	log_level	INFO	Default logging level
INSTRUMENT	symbol_qty_cap	{"RELIANCE":5000,"TCS":3000}	Symbol-level max quantity
2.2 Java Settings Service
public class SettingsService {
    private final JdbcTemplate jdbc;

    public SettingsService(JdbcTemplate jdbc) {
        this.jdbc = jdbc;
    }

    public String getValue(String category, String key) {
        return jdbc.queryForObject(
            "SELECT value FROM settings WHERE category = ? AND key = ?",
            new Object[]{category, key},
            String.class
        );
    }

    public void updateValue(String category, String key, String value) {
        jdbc.update(
            "INSERT INTO settings(category,key,value) VALUES(?,?,?) " +
            "ON CONFLICT(category,key) DO UPDATE SET value=excluded.value, updated_at=CURRENT_TIMESTAMP",
            category, key, value
        );
    }

    public Map<String,String> getAllByCategory(String category) {
        return jdbc.query("SELECT key,value FROM settings WHERE category=?",
            new Object[]{category},
            rs -> {
                Map<String,String> map = new HashMap<>();
                while(rs.next()) {
                    map.put(rs.getString("key"), rs.getString("value"));
                }
                return map;
            }
        );
    }
}


Settings can control:

MTF / MIS eligibility toggles

Intraday margin limits

Symbol-level quantity caps

Trade-for-trade enforcement

FO rollover behavior

IPO day-0 restrictions

2.3 Runtime Settings Usage

Instrument Loader / Cache reads mtf_enabled_default, mis_enabled_default.

Risk Engine reads intraday_var_threshold and symbol_qty_cap.

Market Session Engine reads trade-for-trade, auction, and call market flags.

All changes can be applied without backend redeployment.

3. Logging Infrastructure
3.1 Table-based Logging (Optional for auditing)
CREATE TABLE audit_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    level TEXT NOT NULL,
    category TEXT NOT NULL,  -- e.g., INSTRUMENT, ORDER, RISK
    message TEXT NOT NULL,
    metadata TEXT             -- JSON for extra info
);


Store logs for compliance and audit purposes.

Can be used for trade event replay or risk investigations.

3.2 Java Logging Utility
public class LoggerService {
    private final JdbcTemplate jdbc;
    private final SettingsService settings;

    public LoggerService(JdbcTemplate jdbc, SettingsService settings) {
        this.jdbc = jdbc;
        this.settings = settings;
    }

    public void log(String category, String level, String message, Map<String,Object> metadata) {
        String configuredLevel = settings.getValue("LOGGING", "log_level");
        if (shouldLog(level, configuredLevel)) {
            jdbc.update(
                "INSERT INTO audit_log(category,level,message,metadata) VALUES(?,?,?,?)",
                category, level, message, metadata != null ? new JSONObject(metadata).toString() : null
            );
        }
    }

    private boolean shouldLog(String msgLevel, String configuredLevel) {
        List<String> levels = Arrays.asList("DEBUG","INFO","WARN","ERROR");
        return levels.indexOf(msgLevel.toUpperCase()) >= levels.indexOf(configuredLevel.toUpperCase());
    }
}

3.3 Logging Categories
Category	Description
INSTRUMENT	Instrument loader / cache updates, eligibility changes
ORDER	Order placements, cancellations, rejects
RISK	Risk violations, VaR throttle events, margin alerts
MARKET	Auction, call market, rollover events
MBAL	Multi-broker adapter events
SYSTEM	Errors, warnings, config changes
4. CLI / REST Endpoints for Settings
# CLI examples
./trader-cli settings get INSTRUMENT mtf_enabled_default
./trader-cli settings update RISK intraday_var_threshold 120000
./trader-cli settings list LOGGING

# REST endpoints
GET /api/settings?category=INSTRUMENT
PUT /api/settings/{category}/{key}  { "value": "true" }


Enables frontend admin panel for trading configuration.

Frontend can dynamically reflect series restrictions, margins, and eligibility.

5. Frontend Integration

Admin dashboard shows:

Symbol-level quantity caps

Intraday margin % by series

IPO day-0 / PCA restrictions

Log level and audit status

Supports real-time changes via WebSocket or REST polling.

This design now fully covers:

Instrument Services

Product eligibility & dynamic cache

Market session / FO rollover / T2T enforcement

Risk enforcement (client, symbol, intraday VaR, SPAN margin)

Multi-broker abstraction

Frontend/CLI/REST integration

Settings management for instruments & risk

Logging & audit infrastructure