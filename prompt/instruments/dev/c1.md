Below is a full, implementation-oriented blueprint for all five items, aligned with your Vega Trader Java backend, SQLite + Flyway, broker-agnostic RMS/OMS architecture, and Indian market realities.

This is not theory — it is what you build, module by module.

1. Client-Level Risk Limits
Purpose

Protect capital per client, independent of instrument rules.

This is the primary kill-switch layer.

1.1 Schema (Flyway)
V13__client_risk_limits.sql
CREATE TABLE client_risk_limits (
    client_id              TEXT PRIMARY KEY,
    max_gross_exposure     REAL NOT NULL,
    max_net_exposure       REAL NOT NULL,
    max_order_value        REAL NOT NULL,
    max_intraday_turnover  REAL NOT NULL,
    max_open_positions     INTEGER NOT NULL,
    max_intraday_loss      REAL NOT NULL,
    trading_enabled        INTEGER NOT NULL DEFAULT 1
);

1.2 Runtime State (MTM)
client_risk_state
CREATE TABLE client_risk_state (
    client_id          TEXT PRIMARY KEY,
    current_mtm        REAL NOT NULL,
    gross_exposure     REAL NOT NULL,
    net_exposure       REAL NOT NULL,
    intraday_turnover REAL NOT NULL
);

1.3 Enforcement Flow
validateClientLimits(order) {
    if (!client.enabled) reject("CLIENT_DISABLED");
    if (order.value > maxOrderValue) reject("ORDER_VALUE_LIMIT");
    if (grossExposureAfter > maxGross) reject("GROSS_EXPOSURE_LIMIT");
    if (mtmLoss > maxIntradayLoss) reject("MAX_LOSS_HIT");
}


Where it sits

Order → Instrument RMS → Client RMS → Broker

2. Portfolio Margin (SPAN-Style – Practical Broker-Side)
Reality Check

True SPAN = exchange-licensed.
You implement scenario-based approximation (industry standard).

2.1 Schema
V14__portfolio_positions.sql
CREATE TABLE portfolio_positions (
    client_id       TEXT,
    instrument_key  TEXT,
    quantity        INTEGER,
    avg_price       REAL,
    product         TEXT,
    PRIMARY KEY (client_id, instrument_key)
);

2.2 Risk Scenario Grid

You simulate:

Price ±1σ, ±2σ

Volatility ±Δ

Time decay (FO)

2.3 Margin Calculation
double worstCaseLoss = scenarios.stream()
    .map(s -> portfolioPnL(s))
    .min()
    .orElse(0);

requiredMargin = abs(worstCaseLoss) * safetyFactor;

2.4 Usage

Replaces static MIS margin

Feeds into client RMS

Reduces margin when hedged

3. Intraday VaR Throttling
Purpose

Dynamic throttling during volatility spikes.

3.1 Inputs

1–5 min returns

Instrument volatility

Position Greeks (FO)

Correlation (optional)

3.2 Schema
V15__client_var_thresholds.sql
CREATE TABLE client_var_thresholds (
    client_id TEXT PRIMARY KEY,
    max_var   REAL NOT NULL
);

3.3 VaR Computation
VaR = Z * portfolioVolatility * sqrt(time);

3.4 Throttling Rules
Condition	Action
VaR < 70%	Normal
70–90%	Reduce order size
>90%	Disable MIS
>100%	Kill switch
3.5 Integration Point
Market Data → VaR Engine → Client RMS → Order Gate

4. Auction / Call Market Handling
Purpose

Handle non-continuous markets correctly.

4.1 Market Phase Model
V16__market_phase.sql
CREATE TABLE market_phase (
    exchange TEXT,
    segment  TEXT,
    phase    TEXT, -- PRE_OPEN, OPEN, AUCTION, CLOSE
    start_ts DATETIME,
    end_ts   DATETIME
);

4.2 Order Rules in Auction
Rule	Allowed
CNC only	✅
MIS / MTF	❌
Market orders	❌
Modify after cut	❌
Netting	❌
4.3 Guard
if (marketPhase == AUCTION) {
    if (!order.product.equals("CNC")) reject();
    if (order.type == MARKET) reject();
}

5. Multi-Broker Abstraction Layer
Purpose

Remove broker lock-in forever.

5.1 Core Interface
public interface BrokerAdapter {

    OrderResponse placeOrder(NormalizedOrder order);

    void cancelOrder(String brokerOrderId);

    Stream<MarketEvent> marketStream();

    BrokerMargin getMargin(String clientId);
}

5.2 Normalized Order Model
public record NormalizedOrder(
    String internalInstrumentKey,
    Side side,
    int quantity,
    OrderType type,
    Product product,
    double price
) {}

5.3 Adapters
broker-adapter/
├── upstox/
│   └── UpstoxAdapter
├── fyers/
│   └── FyersAdapter
└── zerodha/
    └── ZerodhaAdapter

5.4 Instrument Mapping Table
CREATE TABLE broker_instrument_map (
    internal_key TEXT,
    broker       TEXT,
    broker_key   TEXT,
    PRIMARY KEY (internal_key, broker)
);

6. End-to-End Order Flow (Final)
UI
 ↓
Symbol Search
 ↓
Instrument RMS
 ↓
Client RMS
 ↓
VaR Engine
 ↓
Portfolio Margin
 ↓
Market Phase Guard
 ↓
Broker Adapter
 ↓
Exchange

7. Implementation Priority (Strong Recommendation)

1️⃣ Client-level risk limits
2️⃣ Multi-broker abstraction
3️⃣ Intraday VaR throttling
4️⃣ Auction handling
5️⃣ Portfolio margin (last)

This order minimizes blast radius and maximizes stability.