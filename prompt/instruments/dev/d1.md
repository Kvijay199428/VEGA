Next, we implement Intraday VaR Throttling, fully integrated with the Client-Level Risk Limits module we just built. This is real-time intraday risk control, throttling client orders when projected VaR (Value at Risk) exceeds limits.

MODULE 2 — INTRADAY VAR THROTTLING
1. Overview

Computes portfolio-level VaR per client in real-time.

Works on tick-level updates, e.g., as orders arrive or market moves.

Integrates with ClientRiskEvaluator for combined checks.

Supports throttling, i.e., delays or rejects orders dynamically.

Works for CNC / MIS / MTF products.

2. Database Layer (Flyway)
V15__client_var_limits.sql
CREATE TABLE client_var_limits (
    client_id      TEXT PRIMARY KEY,
    intraday_var   REAL NOT NULL,
    threshold_var  REAL NOT NULL
);

V16__client_var_state.sql
CREATE TABLE client_var_state (
    client_id      TEXT PRIMARY KEY,
    current_var    REAL NOT NULL,
    last_update    INTEGER NOT NULL
);

3. Domain Models
ClientVarLimit.java
public record ClientVarLimit(
        String clientId,
        double intradayVar,
        double thresholdVar
) {}

ClientVarState.java
public record ClientVarState(
        String clientId,
        double currentVar,
        long lastUpdate
) {}

4. DAO Layer
ClientVarLimitDao.java
public interface ClientVarLimitDao {
    ClientVarLimit find(String clientId);
    void update(ClientVarLimit limit);
}

ClientVarStateDao.java
public interface ClientVarStateDao {
    ClientVarState find(String clientId);
    void upsert(ClientVarState state);
}

5. VaR Engine
IntradayVarEngine.java
public class IntradayVarEngine {

    private final ClientVarLimitDao limitDao;
    private final ClientVarStateDao stateDao;

    public IntradayVarEngine(ClientVarLimitDao limitDao, ClientVarStateDao stateDao) {
        this.limitDao = limitDao;
        this.stateDao = stateDao;
    }

    public void applyVaR(String clientId, double projectedVar) {
        ClientVarLimit limit = limitDao.find(clientId);
        ClientVarState state = stateDao.find(clientId);

        double currentVar = projectedVar; // updated tick-level computation
        stateDao.upsert(new ClientVarState(clientId, currentVar, System.currentTimeMillis()));

        if (currentVar > limit.thresholdVar) {
            throw new RiskReject("INTRADAY_VAR_EXCEEDED");
        }
    }
}

6. Integration with Client Risk Evaluator
public void validateWithVaR(ClientRiskLimit limit, ClientRiskState state, double orderValue, double projectedGross, double projectedNet, int projectedPositions, IntradayVarEngine varEngine) {

    // Standard client-level checks
    validate(limit, state, orderValue, projectedGross, projectedNet, projectedPositions);

    // VaR throttling
    double projectedVar = computeProjectedVaR(state, orderValue); // tick-level or model-based
    varEngine.applyVaR(limit.clientId(), projectedVar);
}

VaR Computation (Simplified)
private double computeProjectedVaR(ClientRiskState state, double orderValue) {
    // Delta-normal approximation
    double volatility = 0.02; // assume 2% per instrument as example
    return Math.abs(orderValue) * volatility * Math.sqrt(1.0 / 252); // daily-to-intraday scaling
}

7. Use Cases
Scenario	Behavior
Projected VaR < threshold	Orders pass normally
Projected VaR ≥ threshold	Orders rejected or throttled
Tick update increases VaR	Immediate re-check and throttle
Portfolio MTM hits loss	Combined with ClientRiskEvaluator limits
8. Unit Test (SQLite In-Memory)
@Test
void rejectWhenVarExceeded() {
    ClientVarLimit limit = new ClientVarLimit("C1", 0, 50_000);
    ClientVarState state = new ClientVarState("C1", 45_000, System.currentTimeMillis());

    when(varLimitDao.find("C1")).thenReturn(limit);
    when(varStateDao.find("C1")).thenReturn(state);

    assertThrows(RiskReject.class, () -> varEngine.applyVaR("C1", 55_000));
}

9. Integration with OMS
Order Request
  → ClientRiskEvaluator
  → IntradayVarEngine (tick-level VaR)
  → FO Rollover / Trade-for-Trade check
  → Broker Adapter

Key Notes

Realtime Computation: Must compute projected VaR per incoming order.

Intraday Scaling: Convert daily volatility to intraday exposure.

Integration: Works seamlessly with CNC, MIS, MTF products.

Fail-Safe: If VaR engine fails, reject orders (default safe behavior).