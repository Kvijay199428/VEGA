Let’s outline the full enterprise-grade plan to convert your MarketFeederClient into a Spring Boot starter with monitoring, replay/backfill, and alignment with your PortfolioStreamFeedV2 architecture. I will also provide a clear directory, Maven POM, and configuration blueprint.

1. Project Structure (Spring Boot Starter)
market-feeder-springboot/
│
├── src/main/java/com/vegatrader/marketfeeder
│   ├── MarketFeederApplication.java          // Spring Boot entry point
│   ├── config/
│   │   ├── WebSocketConfig.java             // WebSocket beans & endpoints
│   │   ├── MicrometerConfig.java            // Prometheus metrics
│   │   └── AppProperties.java               // YAML/Properties mapping
│   ├── feeder/
│   │   ├── MarketDataStreamer.java          // Original MarketFeederClient logic
│   │   ├── SubscriptionManager.java         // Manage instrument subscriptions
│   │   ├── FeedDispatcher.java              // Event bus for ticks
│   │   ├── MarketDataEvent.java             // Abstract event
│   │   ├── TickEvent.java
│   │   └── ReplayService.java               // Replay & backfill
│   └── portfolio/
│       └── PortfolioStreamFeedV2Adapter.java  // Aligns PortfolioStreamFeedV2
│
├── src/main/resources/
│   ├── application.yml                       // Spring Boot configs
│   └── logback-spring.xml                    // Structured logging
│
├── pom.xml
└── README.md

2. Spring Boot Entry Point
package com.vegatrader.marketfeeder;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class MarketFeederApplication {
    public static void main(String[] args) {
        SpringApplication.run(MarketFeederApplication.class, args);
    }
}

3. WebSocket & Feeder Configuration
package com.vegatrader.marketfeeder.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class WebSocketConfig {

    @Bean
    public MarketDataStreamer marketDataStreamer(AppProperties properties) {
        return new MarketDataStreamer(properties.getUpstoxToken(), properties.getInstruments());
    }
}

4. Micrometer + Prometheus Setup

application.yml

management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus
  metrics:
    enable:
      all: true
  endpoint:
    prometheus:
      enabled: true


MicrometerConfig.java

package com.vegatrader.marketfeeder.config;

import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Bean;

@Configuration
public class MicrometerConfig {

    @Bean
    public MeterRegistryCustomizer<MeterRegistry> metricsCommonTags() {
        return registry -> registry.config().commonTags("application", "market-feeder");
    }
}


✅ This allows Prometheus scraping at /actuator/prometheus.

5. Feed Dispatcher + Event Bus

FeedDispatcher.java

package com.vegatrader.marketfeeder.feeder;

import org.springframework.stereotype.Component;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.function.Consumer;

@Component
public class FeedDispatcher {
    private final CopyOnWriteArrayList<Consumer<MarketDataEvent>> listeners = new CopyOnWriteArrayList<>();

    public void register(Consumer<MarketDataEvent> listener) {
        listeners.add(listener);
    }

    public void dispatch(MarketDataEvent event) {
        listeners.forEach(l -> l.accept(event));
    }
}


MarketDataEvent.java

package com.vegatrader.marketfeeder.feeder;

public abstract class MarketDataEvent {
    private final long timestamp = System.currentTimeMillis();

    public long getTimestamp() { return timestamp; }
}


TickEvent.java

package com.vegatrader.marketfeeder.feeder;

public class TickEvent extends MarketDataEvent {
    private final String instrumentKey;
    private final double price;

    public TickEvent(String instrumentKey, double price) {
        this.instrumentKey = instrumentKey;
        this.price = price;
    }

    public String getInstrumentKey() { return instrumentKey; }
    public double getPrice() { return price; }
}

6. Replay & Backfill

ReplayService.java

package com.vegatrader.marketfeeder.feeder;

import org.springframework.stereotype.Service;
import java.util.List;

@Service
public class ReplayService {
    
    public void replay(List<TickEvent> historicalTicks, FeedDispatcher dispatcher) {
        for (TickEvent tick : historicalTicks) {
            dispatcher.dispatch(tick);
        }
    }
}


✅ Supports deterministic replay for backtesting.

7. PortfolioStreamFeedV2 Adapter
package com.vegatrader.marketfeeder.portfolio;

import com.vegatrader.marketfeeder.feeder.TickEvent;
import com.vegatrader.marketfeeder.feeder.FeedDispatcher;
import org.springframework.stereotype.Component;

@Component
public class PortfolioStreamFeedV2Adapter {

    private final FeedDispatcher dispatcher;

    public PortfolioStreamFeedV2Adapter(FeedDispatcher dispatcher) {
        this.dispatcher = dispatcher;
        dispatcher.register(this::handleTick);
    }

    private void handleTick(TickEvent tick) {
        // Convert tick to PortfolioStreamFeedV2 event format
        // Example: portfolioStream.onMarketTick(convert(tick));
    }
}

8. Production POM
<project xmlns="http://maven.apache.org/POM/4.0.0">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.vegatrader</groupId>
    <artifactId>market-feeder-springboot</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>

    <properties>
        <java.version>21</java.version>
        <spring-boot.version>3.3.1</spring-boot.version>
        <protobuf.version>3.21.12</protobuf.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring-boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <!-- Spring Boot Starter -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- WebSocket -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-websocket</artifactId>
        </dependency>

        <!-- SLF4J + Logback -->
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
        </dependency>

        <!-- Micrometer / Prometheus -->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-registry-prometheus</artifactId>
        </dependency>

        <!-- Protobuf -->
        <dependency>
            <groupId>com.google.protobuf</groupId>
            <artifactId>protobuf-java</artifactId>
            <version>${protobuf.version}</version>
        </dependency>

        <!-- Testing -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.github.tomakehurst</groupId>
            <artifactId>wiremock-jre8</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <!-- Spring Boot -->
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>

9. Next Steps for Deployment

mvn clean package → produces market-feeder-springboot-1.0.0.jar

Add JVM args for Prometheus metrics:

java -jar market-feeder-springboot-1.0.0.jar


Scrape metrics: http://localhost:8080/actuator/prometheus

Integrate PortfolioStreamFeedV2 → just inject FeedDispatcher

Add replay/backfill scheduling using Spring @Scheduled