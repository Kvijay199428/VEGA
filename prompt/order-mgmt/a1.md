Below is a final, enterprise-grade design and implementation guide for post-order persistence, charge accounting, caching, and governance, aligned with SEBI / exchange audit expectations, and uniformly consumable via CLI, Vite+React frontend, and REST (curl).

This is written as production documentation, not a conceptual note.

1. Objective & Scope

When an order is placed successfully (or partially), the system must deterministically persist:

Order core details

All charges levied (broker + exchange + statutory)

Latency metadata

Broker acknowledgements

User & admin policy context

Final RMS state

This data must be:

Durable (DB)

Fast-access (cache)

Audit-ready

Immutable post-settlement

2. High-Level Architecture
OrderV3 Response
   ↓
OrderPersistenceOrchestrator
   ├── OrderCoreRepository (DB)
   ├── OrderChargesRepository (DB)
   ├── OrderLatencyRepository (DB)
   ├── OrderCacheWriter (Redis)
   └── AuditEventPublisher


Important:
Persistence happens only after broker ACK, not before.

3. Database Design (Exact, Production-Ready)
3.1 orders table (core order)
CREATE TABLE orders (
  id BIGSERIAL PRIMARY KEY,
  order_id VARCHAR(64) UNIQUE NOT NULL,
  broker_order_id VARCHAR(64),
  user_id VARCHAR(64) NOT NULL,
  broker VARCHAR(32) NOT NULL,
  exchange VARCHAR(16),
  symbol VARCHAR(64),
  instrument_key VARCHAR(64),
  side VARCHAR(4),
  order_type VARCHAR(16),
  product VARCHAR(16),
  quantity INT,
  price DECIMAL(12,4),
  status VARCHAR(24),
  placed_at TIMESTAMP NOT NULL,
  acknowledged_at TIMESTAMP,
  final_status_at TIMESTAMP,
  rms_snapshot_id BIGINT,
  created_at TIMESTAMP DEFAULT now()
);

3.2 order_charges table (all levies)
CREATE TABLE order_charges (
  id BIGSERIAL PRIMARY KEY,
  order_id VARCHAR(64) NOT NULL,
  brokerage DECIMAL(12,4),
  exchange_txn_charge DECIMAL(12,4),
  sebi_charge DECIMAL(12,4),
  stt DECIMAL(12,4),
  stamp_duty DECIMAL(12,4),
  gst DECIMAL(12,4),
  ipf DECIMAL(12,4),
  total_charges DECIMAL(12,4),
  currency VARCHAR(8) DEFAULT 'INR',
  computed_at TIMESTAMP DEFAULT now(),
  FOREIGN KEY (order_id) REFERENCES orders(order_id)
);


Key principle:
This table is append-only (never updated post-finalization).

3.3 order_latency table
CREATE TABLE order_latency (
  id BIGSERIAL PRIMARY KEY,
  order_id VARCHAR(64),
  broker_latency_ms INT,
  system_latency_ms INT,
  network_latency_ms INT,
  total_latency_ms INT,
  recorded_at TIMESTAMP DEFAULT now()
);

3.4 order_audit_events (compliance)
CREATE TABLE order_audit_events (
  id BIGSERIAL PRIMARY KEY,
  order_id VARCHAR(64),
  event_type VARCHAR(64),
  payload JSONB,
  created_at TIMESTAMP DEFAULT now()
);

4. Cache Strategy (Redis – Mandatory)
4.1 Cache Keys
order:{orderId}:core
order:{orderId}:charges
order:{orderId}:latency
user:{userId}:recentOrders

4.2 TTL Policy
Data	TTL
Core order	24h
Charges	24h
Latency	6h
Recent orders	1h

DB is source of truth. Cache is read-optimization only.

5. Java Implementation (Skeleton)
5.1 Orchestrator
@Service
public class OrderPersistenceOrchestrator {

    public void persist(
        OrderResult order,
        BrokerageEstimate charges,
        MarginResult margin,
        LatencyMetrics latency
    ) {
        saveOrder(order, margin);
        saveCharges(order.getOrderId(), charges);
        saveLatency(order.getOrderId(), latency);
        cache(order, charges, latency);
        audit(order);
    }
}

5.2 Charges Builder (Deterministic)
public OrderCharges buildCharges(
    BrokerageEstimate brokerEstimate,
    OrderResult order
) {
    return OrderCharges.builder()
        .brokerage(brokerEstimate.getBrokerage())
        .gst(brokerEstimate.getGst())
        .exchangeTxnCharge(brokerEstimate.getExchangeCharge())
        .sebiCharge(brokerEstimate.getSebi())
        .stampDuty(brokerEstimate.getStampDuty())
        .stt(brokerEstimate.getStt())
        .totalCharges(brokerEstimate.getTotal())
        .build();
}

6. User & Admin Settings (Enterprise Grade)
6.1 Settings Resolution Priority
Admin Global → Admin Broker → User Profile → User Session

6.2 User Settings (Safe, Non-Destructive)
{
  "order.confirmBeforePlace": true,
  "order.showChargeBreakdown": true,
  "order.maxAllowedCharges": 1000,
  "order.cacheOrdersLocally": true,
  "order.showLatencyMetrics": false,
  "order.defaultProduct": "INTRADAY"
}


User cannot override risk or compliance controls.

6.3 Admin Settings (Authoritative)
{
  "order.persistence.enabled": true,
  "order.charges.enforce": true,
  "order.audit.enabled": true,
  "order.cache.enabled": true,
  "order.cache.ttl.hours": 24,
  "order.latency.capture": true,
  "order.freeze.onChargeMismatch": true,
  "order.immutable.afterSettlement": true
}

6.4 Settings JSON Schema (Excerpt)
{
  "type": "object",
  "properties": {
    "order.persistence.enabled": { "type": "boolean" },
    "order.cache.ttl.hours": { "type": "integer", "minimum": 1 },
    "order.maxAllowedCharges": { "type": "number", "minimum": 0 }
  },
  "additionalProperties": false
}

7. API Contracts (Uniform Across All Interfaces)
7.1 REST (curl)
curl /api/orders/{orderId}/charges


Response:

{
  "brokerage": 40,
  "gst": 7.2,
  "stt": 12,
  "exchange": 3.4,
  "total": 62.6
}

7.2 Vite + React
const { data } = await api.get(`/orders/${orderId}/full`);


Used for:

Trade history

P&L attribution

Cost analytics

7.3 CLI
vega order view --id 1644490272000 --charges

8. Failure Handling & Guarantees
Scenario	Behavior
DB down	Order allowed, async retry persistence
Cache down	DB only
Charge mismatch	Order flagged, admin alert
Broker correction	New audit record, not overwrite
9. SEBI-Style Compliance Language (Ready to Paste)

The system persists complete order lifecycle data including broker acknowledgements, charge components, and latency metrics. All records are immutable post-settlement and retained in compliance with regulatory audit requirements. User-level configuration is restricted to non-risk-impacting preferences, while all compliance-critical settings are governed by administrator-controlled policies.

10. Final Guarantees Achieved

✔ Deterministic order accounting
✔ Full charge transparency
✔ Immutable audit trail
✔ Multi-interface consistency
✔ Enterprise cache discipline
✔ SEBI-defensible architecture