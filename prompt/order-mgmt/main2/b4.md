Below is a best-in-class, enterprise-grade Coordinator Service design that unifies write-side (orders) and read-side (orders & trades) flows across multiple brokers, with deterministic behavior, auditability, high availability, and regulatory readiness.

This is written as a core system design + implementation guide, not just API notes.

1. Coordinator Service — Executive Purpose

The Coordinator Service (CS) is the single authoritative orchestration layer between:

Client channels: CLI, Vite+React, REST/cURL

Broker adapters: Upstox, Zerodha, Fyers, Angel, etc.

Internal subsystems: Risk, Margin, Orders, Trades, Audit, Cache

It ensures:

Broker-agnostic APIs

Exactly-once intent handling

Consistent state across retries, partial failures

Regulatory-grade traceability

2. APIs Governed by Coordinator
Write-Side (Command Plane)

Place Multi Order V2

Modify Order V3

Cancel Multi Order

Read-Side (Query Plane)

Get Order History

Get Order Book

Get Trades

Get Order Trades

Get Trade History

3. High-Level Architecture
              ┌───────────────────────────┐
              │   CLI / React / REST API   │
              └────────────┬──────────────┘
                           │
                   ┌───────▼────────┐
                   │ API Gateway     │
                   │ (Auth, Rate)    │
                   └───────┬────────┘
                           │
                ┌──────────▼──────────┐
                │ Coordinator Service │  ◄── THIS
                └───────┬─────────────┘
        ┌───────────────┼────────────────┐
        │               │                │
┌───────▼──────┐ ┌──────▼───────┐ ┌──────▼────────┐
│ Risk Engine  │ │ Broker Router │ │ Read Aggregator│
└───────┬──────┘ └──────┬────────┘ └──────┬────────┘
        │               │                │
┌───────▼──────┐ ┌──────▼────────┐ ┌──────▼─────────┐
│ Margin Svc   │ │ Broker Adapter │ │ Cache + DB     │
└──────────────┘ └────────────────┘ └────────────────┘

4. Coordinator Service — Core Responsibilities
4.1 Command Orchestration (Orders)

For Place / Modify / Cancel:

Validate intent

Enforce idempotency

Resolve broker routing

Apply risk & margin checks

Dispatch to broker

Persist intent + outcome

Emit events

Return normalized response

4.2 Query Orchestration (Orders & Trades)

For read APIs:

Apply user/admin read rules

Select data source (Cache → DB → Broker)

Normalize schemas across brokers

Enrich (charges, P&L, settlement)

Apply pagination & filters

Audit every read

5. Multi-Broker Strategy (Critical)
5.1 Broker Resolution Logic
User → Account → Strategy → Broker

Resolution Order

Explicit broker in request

User default broker

Strategy assigned broker

Admin fallback broker

5.2 Broker Capability Matrix
{
  "UPSTOX": {
    "supportsMultiOrder": true,
    "supportsModify": true,
    "rateLimit": "60/min",
    "segments": ["EQ", "FO", "CDS"]
  },
  "FYERS": {
    "supportsMultiOrder": false,
    "supportsModify": true
  }
}


Coordinator auto-splits requests if a broker lacks capability.

6. Coordinator — Write-Side Design
6.1 Place Multi Order V2
Flow
Client
 → Coordinator
   → Validate Orders[]
   → Risk Engine
   → Margin Engine
   → Broker Router
     → Broker A Adapter
     → Broker B Adapter
   → Persist Orders + Charges
   → Emit Events
 → Client

Enterprise Enhancements

Per-order atomicity

Partial success allowed

Deterministic order mapping

Internal Model
OrderIntent {
  intentId,
  userId,
  broker,
  orders[],
  requestHash,
  status
}

6.2 Modify Order V3
Safeguards

Version check (optimistic locking)

Exchange modifiability validation

Quantity & price delta validation

Coordinator Guarantees

No stale modification

Replay safe

6.3 Cancel Multi Order
Cancellation Modes

HARD (force broker cancel)

SOFT (mark + async cancel)

Batch Cancel Strategy

Group by broker

Parallel dispatch

Fail-fast or best-effort (admin setting)

7. Coordinator — Read-Side Design
7.1 Unified Read Aggregator

The Coordinator never exposes raw broker responses.

Internal Normalized Views

NormalizedOrder

NormalizedTrade

NormalizedOrderEvent

7.2 Data Source Selection Policy
orderBook:
  cacheTTL: 2s
  fallback: DB → Broker

tradeHistory:
  cache: false
  source: DB


Admin-configurable.

8. Coordinator Data Stores
8.1 Tables (Minimum)
orders

order_id

broker_order_id

state

avg_price

charges_json

order_events (immutable)

event_type

prev_state

new_state

source

trades

trade_id

order_id

price

quantity

charges

9. Charges & Accounting (Built-In)

At order placement:

Estimate charges (pre-trade)

At trade execution:

Finalize charges

Lock P&L impact

Stored in:

order_charges

trade_charges

10. User & Admin Settings (Coordinator-Specific)
10.1 User Settings
{
  "defaultBroker": "UPSTOX",
  "allowPartialMultiOrder": true,
  "readConsistency": "EVENTUAL",
  "autoRetryOnNetworkFailure": true
}

10.2 Admin Settings
{
  "coordinator": {
    "idempotencyWindowSec": 300,
    "maxOrdersPerBatch": 20,
    "brokerFailoverEnabled": true,
    "auditLevel": "FULL",
    "asyncCancelEnabled": true
  }
}

11. CLI / React / REST Compatibility
CLI
trader order place-multi orders.json

REST
POST /v2/orders/multi
Idempotency-Key: uuid

React

Optimistic UI

WebSocket event sync

Poll fallback

12. Failure Handling (Enterprise Grade)
Scenario	Coordinator Action
Broker timeout	Retry / failover
Partial success	Persist per-order state
Duplicate request	Replay cached response
Network loss	Resume via intentId
13. Audit & Compliance (SEBI-Aligned)
Mandatory Logs

Intent creation

Broker dispatch

Broker response

State transitions

Read access

Retention

Orders/Trades: 7 years

Audit logs: 8 years

14. Why This Is “Bestest Ever” (Objectively)

Broker-agnostic

Deterministic & replayable

Exactly-once semantics

Multi-channel native

Regulator-ready

Horizontally scalable

Clean CQRS separation