Let’s move to the fifth module – Exit All Positions, keeping the enterprise-grade, industry-level standards, with user/admin settings, CLI, Vite+React integration, and audit best practices.

5. Exit All Positions – Enterprise Implementation Guide
Overview

The Exit All Positions API allows closing all open positions for a user or a strategy in one atomic action. This is essential for risk management, end-of-day liquidation, or emergency market exits.

Key Features:

Close all positions across multiple instruments and strategies.

Supports partial closure for selected instruments or positions.

Works seamlessly with Place Multi Order V2 and Cancel Multi Order.

Tracks real-time execution and average exit price per instrument.

User/Admin-Centric Settings
User Settings

Access Token: Required for authorization.

Scope of Exit:

All positions for the user.

Positions for a specific strategy tag.

Positions for selected instruments.

Execution Type:

MARKET: Immediate exit at market price.

LIMIT: User-defined limit exit price.

Partial Exit Options:

Exit full quantity or partial quantity per position.

Admin Settings

Rate Limiting:

Prevent large-scale exit orders from overloading the system.

Audit Logging:

Maintain before/after snapshots of positions.

Track exit time, average price, user, strategy, instrument.

Retry Mechanism:

Automatically retry unfilled positions.

Alerts & Monitoring:

Real-time notifications for failed exits or high-volume position exits.

Compliance Rules:

Enforce max loss or exposure thresholds before exit.

API Request Structure

Endpoint:

POST /v3/positions/exit_all
Sandbox: https://api-sandbox.upstox.com/v3/positions/exit_all
Live: https://api.upstox.com/v3/positions/exit_all
Authorization: Bearer <access_token>
Content-Type: application/json


Payload Example – Exit All Positions for User:

{
  "user_id": "user123",
  "execution_type": "MARKET"
}


Payload Example – Exit Positions by Strategy Tag:

{
  "strategy_tag": "intraday_nifty",
  "execution_type": "MARKET"
}


Payload Example – Exit Selected Instruments Only:

{
  "user_id": "user123",
  "instruments": ["NSE:INFY", "NSE:TCS"],
  "execution_type": "LIMIT",
  "limit_prices": {"NSE:INFY": 1550, "NSE:TCS": 3300}
}

Response Structure

Success Example (HTTP 200):

{
  "status": "success",
  "data": [
    {"instrument": "NSE:INFY", "exit_quantity": 100, "exit_price": 1550, "status": "CLOSED"},
    {"instrument": "NSE:TCS", "exit_quantity": 50, "exit_price": 3300, "status": "CLOSED"}
  ]
}


Partial Success Example:

{
  "status": "partial_success",
  "data": [
    {"instrument": "NSE:INFY", "exit_quantity": 100, "exit_price": 1550, "status": "CLOSED"},
    {"instrument": "NSE:TCS", "exit_quantity": 50, "status": "FAILED", "error": "Market closed"}
  ]
}


Error Example (HTTP 400):

{
  "status": "error",
  "error_code": "NO_OPEN_POSITIONS",
  "message": "No open positions found for user."
}

Enterprise Best Practices

Pre-Exit Validation

Fetch all open positions via Get Positions API.

Validate position size and market status.

Partial Exit Handling

Exit positions in chunks for high-volume portfolios.

Retry only failed instruments automatically.

Audit & Logging

Log all positions before exit and exit confirmation.

Include user ID, strategy tag, instrument, exit quantity, price, timestamp.

CLI Usage

# Exit all positions for a user
curl -X POST "https://api.upstox.com/v3/positions/exit_all" \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Content-Type: application/json" \
-d '{"user_id": "user123", "execution_type": "MARKET"}'

# Exit positions by strategy
curl -X POST "https://api.upstox.com/v3/positions/exit_all" \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Content-Type: application/json" \
-d '{"strategy_tag": "intraday_nifty", "execution_type": "MARKET"}'


Vite+React Integration

Use Axios.post() with payload for exit instructions.

Maintain a real-time position map showing CLOSED or FAILED.

Notify users immediately if any position fails to exit.

Admin Dashboard

Display real-time exit logs with:

User, strategy, instrument, exit quantity, exit price, timestamp.

Provide filtering by user, strategy, or instrument.

Alert admins on bulk exits, failed exits, or abnormal market activity.

Security

Validate user roles and access permissions before exit.

Enforce market hours checks for exit orders.

Secure all requests with HTTPS.

Recommended Enterprise Workflow

Retrieve all open positions using Get Positions API.

Filter positions for strategy, user, or instrument if required.

Execute Exit All Positions API request.

Update frontend dashboard with real-time exit statuses.

Log before/after snapshots in the audit system.

Retry failed exits if any positions remain open.