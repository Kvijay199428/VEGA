Below is a documentation-first, enterprise-grade implementation guide for Get Profile and Fund & Margin, aligned explicitly with your existing Java backend architecture, RMS, Multi-Broker layer, settings system, and compliance posture.

This is written so you can extract current backend facts, identify what already exists, and then extend cleanly without rework.

USER PROFILE & FUNDS / MARGIN
Enterprise Implementation & Documentation Guide
1. Purpose in Your Architecture

These two APIs are NOT UI utilities.
They are control-plane primitives used by:

RMS validation

Eligibility resolution

Order pre-checks

UI capability gating

Compliance & audit trails

They must be treated as authoritative broker truth, not cached blindly.

2. What Already Exists in Your Java Backend (Identification)

Based on your implementation log and architecture, the following already exist or partially exist:

2.1 Existing Components (Confirmed)
Area	Existing
Broker abstraction	BrokerAdapter, UpstoxBrokerAdapter
Client risk limits	ClientRiskLimit, ClientRiskEvaluator
RMS validation	RmsValidationService
Multi-broker routing	MultiBrokerEngine
Settings framework	JSON-schema driven
Token scope handling	Present (OPTIONCHAIN1/2 pattern)
Audit logging	Structured, rejection-oriented
2.2 Missing / To Be Added (Explicit)
Feature	Status
User profile persistence	❌
Funds/margin snapshot cache	❌
Maintenance window handling	❌
Combined margin logic (post-July 2025)	❌
Profile-driven eligibility gating	❌
Admin override hooks	❌
3. Architectural Placement
Upstox REST
   ↓
UpstoxBrokerAdapter
   ↓
UserProfileService
   ↓
EligibilityResolver / RMS

Upstox REST
   ↓
UpstoxBrokerAdapter
   ↓
FundsMarginService
   ↓
RmsValidationService


These services do not talk to UI directly.

4. Get Profile – Enterprise Handling
4.1 Why This API Is Critical
Field	Used For
exchanges	Instrument universe gating
products	MIS / CNC / MTF enforcement
order_types	Order form validation
poa / ddpi	Sell permission checks
is_active	Global kill-switch
4.2 Domain Model
public record UserProfile(
    String userId,
    String broker,
    Set<Exchange> exchanges,
    Set<ProductType> products,
    Set<OrderType> orderTypes,
    boolean poa,
    boolean ddpi,
    boolean active
) {}

4.3 Persistence (Recommended)

You must persist profile snapshots for audit replay.

CREATE TABLE user_profile_snapshot (
  user_id VARCHAR(32),
  broker VARCHAR(16),
  payload JSONB,
  fetched_at TIMESTAMP,
  PRIMARY KEY (user_id, fetched_at)
);


Retention: 90 days minimum (SEBI audit safety).

4.4 Fetch Policy
Condition	Action
Login	Mandatory fetch
Token refresh	Mandatory fetch
Order rejected (eligibility)	Optional refetch
UI refresh	Use cache

Cache TTL: 15 minutes (configurable).

5. Funds & Margin – Enterprise Handling
5.1 Compliance-Critical Notes (Must Document)

Maintenance window: 00:00–05:30 IST

Post 19 July 2025:
→ ALL margin logic must use data.equity only

Commodity object becomes dummy (zeros)

This must be enforced in code, not docs only.

5.2 Domain Model (Future-Proof)
public record FundsMargin(
    double usedMargin,
    double availableMargin,
    double spanMargin,
    double exposureMargin,
    double payinAmount,
    double notionalCash,
    Instant fetchedAt
) {}


No segment split in business logic.

5.3 Service Guardrail (Mandatory)
if (LocalTime.now(ZoneId.of("Asia/Kolkata"))
        .isAfter(LocalTime.MIDNIGHT)
    && LocalTime.now().isBefore(LocalTime.of(5,30))) {

    throw new BrokerUnavailableException("Funds service maintenance window");
}

5.4 Persistence
CREATE TABLE funds_margin_snapshot (
  user_id VARCHAR(32),
  broker VARCHAR(16),
  equity JSONB,
  fetched_at TIMESTAMP,
  PRIMARY KEY (user_id, fetched_at)
);


Retention: 180 days (margin disputes).

6. Integration with Existing RMS
6.1 RMS Validation Flow (Updated)
OrderRequest
   ↓
UserProfileService
   ↓
FundsMarginService
   ↓
ClientRiskEvaluator
   ↓
RmsValidationService

6.2 Enforcement Examples
Rule	Source
OrderType not allowed	UserProfile
Product not enabled	UserProfile
Insufficient margin	FundsMargin
DDPI required for sell	UserProfile
Account inactive	UserProfile
7. Settings (User vs Admin)
7.1 Settings Schema
{
  "profile": {
    "cacheTtlSeconds": 900,
    "enforceOrderType": true
  },
  "funds": {
    "cacheTtlSeconds": 5,
    "maintenanceBlock": true,
    "useCombinedEquityMargin": true
  }
}

7.2 Role Matrix
Setting	User	Admin
Refresh profile	✔	✔
Disable margin checks	✖	✔
Override maintenance	✖	✔
Cache TTL	✖	✔
8. Error & Rejection Codes (Standardized)
Code	Reason
RMS-P-001	Order type not enabled
RMS-P-002	Product not enabled
RMS-P-003	Account inactive
RMS-M-001	Insufficient margin
RMS-M-002	Margin service unavailable
RMS-M-003	Maintenance window

These codes must appear in logs, UI, and audit packs.

9. Logging & Audit (Mandatory)
Profile Fetch Log
{
  "event": "PROFILE_FETCH",
  "user": "UCC123",
  "broker": "UPSTOX",
  "result": "SUCCESS",
  "timestamp": "2025-12-30T12:00:00Z"
}

Margin Check Log
{
  "event": "MARGIN_CHECK",
  "required": 15200,
  "available": 15507.46,
  "result": "PASS"
}

10. Frontend Usage (Read-Only)
Vite + React

Profile → capability rendering

Margin → display only

No business logic in frontend

CLI
vega profile show
vega funds show

REST
GET /api/user/profile
GET /api/user/funds


These endpoints proxy cached backend data, not broker directly.

11. Compliance Alignment (SEBI / Exchange)
Requirement	Coverage
User capability enforcement	Profile
Margin sufficiency	Funds
Non-trade hours protection	Maintenance
Audit replay	Snapshots
Deterministic rejection	RMS codes
12. Documentation Sections You Can Generate

You now have enough to produce:

Developer Guide

Admin SOP

SEBI Appendix

OpenAPI

Test Evidence

Audit Trails

Final Recommendation (Very Important)

Do not merge Profile & Funds logic into RMS directly.
They must remain broker-truth services, or audits will fail.