Below is a solution design & implementation document for resolving the identified TODOs in the Java backend, written at an enterprise / industry-grade level suitable for internal engineering review, audit readiness, and phased execution.

This document does not repeat TODOs; instead, it provides how each class should be completed, including architecture decisions, persistence models, API contracts, and operational guarantees.

Vega Trader Backend – TODO Resolution & Solution Design Document
Scope

This document covers:
• Market data & option chain
• Order management & broker adapters
• Risk engine integration
• Admin & compliance services
• Audit & regulatory readiness

The solutions are broker-agnostic, multi-tenant, and SEBI-auditable.

1. AUTH & TOKEN LIFECYCLE
TokenAuditService.java

Objective: Ensure full traceability of token issuance and refresh events.

Solution

Introduce a persistent token_audit table.

Schema (recommended):

token_id (hashed, never store raw token)

broker

client_id

issued_at

expires_at

refresh_type (LOGIN / AUTO_REFRESH / MANUAL)

ip_address

user_agent

created_by (SYSTEM / USER)

Implementation Flow

On successful token generation or refresh:

Hash token using SHA-256

Persist metadata only

No token value is ever retrievable

All failures also logged with reason

Compliance
• Required for incident forensics
• Meets SEBI “access credential lifecycle” expectation

2. USER PROFILE & MARGINS
UserProfileService / FundsMarginService

Objective: Fetch live user profile, margins, and funds via broker adapters.

Solution

Adopt a BrokerAdapter abstraction:

UserProfileService → BrokerRouter → BrokerAdapter → Broker API


Key Principles
• No service calls Upstox directly
• All broker logic is adapter-contained
• Allows future Fyers / Zerodha / Angel integration

Caching
• Margin data cached for 5–10 seconds
• Hard refresh on trade placement

3. OPTION CHAIN & MARKET DATA
OptionChainService.java
API Integration

Implement REST call using:

/v2/option/chain

Auth via bearer token

Timeout ≤ 500ms

Retry only on network failure (no retries on 4xx)

Expiry Fetching

Primary source:

Contract master table (fo_contract_lifecycle)

Fallback:

Broker API (expired instruments endpoint)

Audit Persistence

Create option_chain_audit table:

underlying

expiry

latency_ms

success_flag

error_code

broker

request_ts

This enables:
• Latency analytics
• Broker reliability scoring

4. EXPIRED & HISTORICAL DATA
ExpiredInstrumentServiceImpl

Endpoints Implemented

expired expiries

expired option contracts

expired futures contracts

Storage Strategy
• Persist responses in historical_contract_snapshot
• Immutable records (append-only)

HistoricalMarketDataServiceImpl

Purpose
Backtesting, Greeks validation, and compliance reconstruction.

Implementation
• Fetch candles via expired instruments endpoint
• Normalize into unified OHLC schema
• Tag data source + fetch timestamp

5. EXPIRY & TRADING CALENDAR
ExpiryCalendarService

Solution
Integrate official NSE trading holiday calendar.

Rules
• Weekly expiry shifts if expiry is holiday
• Monthly expiry follows last trading Thursday
• Calendar cached annually

BrokerInstrumentPrewarmJob

Enhancements
• Skip execution on holidays
• Query instruments expiring within T+7
• Preload symbol mappings & greeks

6. ORDER MANAGEMENT & BROKER ADAPTERS
UpstoxBrokerAdapter.java

Design Rule
This class is a thin protocol adapter, not a business logic holder.

Place / Modify / Cancel Order

• Map internal OrderRequest → Upstox schema
• Validate order locally before API call
• Capture broker_order_id immediately

Order Retrieval

• getOrderBook, getTradesForDay, getOrderTrades
• Normalize all responses to internal DTOs

Exit All Positions

• Call /v2/order/positions/exit
• Validate confirmation from broker

Health Check

• Lightweight endpoint call
• Cached for 30 seconds
• Used by BrokerRouter failover logic

7. BROKER ROUTING
BrokerRouter.java

Resolution Order

Explicit broker in request

Strategy-configured broker

User default broker

System priority broker

Integration Points
• UserSettingsService
• StrategyConfigService
• BrokerRegistry

Failover
If broker unavailable:
• Retry next priority broker
• Log broker_failover_event

8. RISK ENGINE
RiskEngine.java

Objective
Prevent breaches before order placement.

Integration
• Query live positions service
• Aggregate qty by instrument & expiry
• Enforce:

Max qty per symbol

Max delta per strategy

Margin availability

Blocking Rules
Hard limits block order
Soft limits warn + audit

9. ADMIN ACTIONS & GOVERNANCE
AdminActionService.java
Repository Injection

Inject repositories for:
• disabled_strikes
• admin_actions_audit
• broker_registry
• broker_symbol_mapping

Disable / Enable Strike

• Insert/update disabled_strikes
• Enforced at order validation layer
• Audit every action

Broker Priority Updates

• Update broker_registry priority column
• Atomic update + audit

Contract Rollback

• Deactivate faulty mapping
• Reactivate previous version
• Log to contract_version_history

10. AUDIT EXPORTS
AuditExportService.java
PDF Generation

Use OpenPDF or iText:
• Orders
• Trades
• Timeline
• Digital signature footer

Export History

Create audit_export_history:

export_type

date_range

exported_by

ip_address

timestamp

Security
• Rate-limited
• Admin-only

11. MULTI-BROKER RESOLUTION
MultiBrokerResolver

Logic
• Read from broker_registry
• Filter by:

Enabled

Health

Priority

Use Cases
• Market data source selection
• Order routing
• Risk calculation source

12. SYSTEM-WIDE GUARANTEES
Determinism

• All calculations reproducible
• Market data timestamped

Observability

• Every external API call logged
• Latency tracked

Compliance

• No silent failures
• No mutable historical data

13. PHASED DELIVERY PLAN
Phase 1 – Blocking TODOs

• BrokerAdapter calls
• Order routing
• Token audit

Phase 2 – Risk & Market Data

• Option chain
• Historical data
• Expiry calendar

Phase 3 – Compliance

• Audit exports
• Admin governance

Final Note

After completing these TODOs, your backend will qualify as:
• Institution-grade trading backend
• SEBI audit defensible
• Multi-broker scalable
• Bloomberg-comparable in risk discipline